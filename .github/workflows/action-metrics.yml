name: GitHub Actions Metrics

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate GitHub Actions Metrics 
        uses: actions/github-script@v7
        with:
          script: | 
            const { owner, repo } = context.repo;
            const fs = require('fs');
            const path = '.github/data/action-metrics.csv';

            const { data } = await github.request(
              'GET /repos/{owner}/{repo}/actions/runs',
              { owner, repo, per_page: 100 }
            );

            const rows = (data.workflow_runs || []).map(run => ({
              id: run.id,
              name: run.name,
              event: run.event,
              status: run.status,
              conclusion: run.conclusion,
              created_at: run.created_at,
              updated_at: run.updated_at,
              duration_seconds: (new Date(run.updated_at) - new Date(run.created_at)) / 1000
            }));

            if (!rows.length) {
              core.info('No workflow runs found; leaving CSV unchanged.');
              fs.mkdirSync('.github/data', { recursive: true });
              if (!fs.existsSync(path)) {
                fs.writeFileSync(path, 'ID,Name,Event,Status,Conclusion,Created At,Updated At,Duration (seconds)\n', 'utf8');
              }
              return;
            }

            const esc = s => `"${String(s).replace(/"/g, '""')}"`;
            const newLines = rows.map(r => `${esc(r.id)},${esc(r.name)},${esc(r.event)},${esc(r.status)},${esc(r.conclusion)},${esc(r.created_at)},${esc(r.updated_at)},${esc(r.duration_seconds)}`).join('\n');

            fs.mkdirSync('.github/data', { recursive: true });
            if (!fs.existsSync(path)) {
              fs.writeFileSync(path, 'ID,Name,Event,Status,Conclusion,Created At,Updated At,Duration (seconds)\n', 'utf8');
            }
            fs.appendFileSync(path, '\n' + newLines, 'utf8');
            core.info(`Appended ${rows.length} rows to ${path}`);
      - name: Commit and push changes
        run: |
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add .github/data/action-metrics.csv
            if git diff --cached --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Update GitHub Actions metrics data"
              git push
            fi
      - name: Setup Python and generate graph
        uses: actions/setup-python@v4
        with:
          python-version: '3.13.7'
      - run: |
          pip install pandas matplotlib
          python .github/scripts/action_graph.py

      - name: Commit graph image
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .github/data/action-graph.png
          git commit -m 'Update GitHub Actions graph' || echo "No changes to commit"
          git push